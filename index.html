<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå¹³å° LLM ç”¨é‡ä»ªè¡¨ç›˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Lora:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap');

        :root {
            --bg-primary: #faf9f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f4f1e8;
            --text-primary: #141413;
            --text-secondary: #6f6b61;
            --border-color: #e8e6dc;
            --accent-color: #d4a24c;
            --accent-hover: #c18e39;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --claude-ink: #141413;
            --claude-yellow: #d4a24c;
            --claude-yellow-soft: #f3e5c7;
            --glow-primary: rgba(212, 162, 76, 0.2);
            --glow-secondary: rgba(217, 119, 87, 0.14);
        }

        [data-theme="dark"] {
            --bg-primary: #141413;
            --bg-secondary: #1f1f1d;
            --bg-tertiary: #2b2a27;
            --text-primary: #faf9f5;
            --text-secondary: #b0aea5;
            --border-color: #3d3a35;
            --accent-color: #e0b866;
            --accent-hover: #d4a24c;
            --claude-ink: #141413;
            --claude-yellow: #e0b866;
            --claude-yellow-soft: #3b3121;
        }

        body {
            font-family: 'Lora', 'PingFang SC', 'Microsoft YaHei', serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            background-image:
                radial-gradient(circle at 15% 10%, var(--glow-primary) 0%, transparent 38%),
                radial-gradient(circle at 85% 20%, var(--glow-secondary) 0%, transparent 32%),
                linear-gradient(180deg, rgba(255, 255, 255, 0.65) 0%, rgba(255, 255, 255, 0) 35%);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] body {
            background-image:
                radial-gradient(circle at 15% 10%, rgba(224, 184, 102, 0.2) 0%, transparent 42%),
                radial-gradient(circle at 85% 20%, rgba(217, 119, 87, 0.16) 0%, transparent 38%),
                linear-gradient(180deg, rgba(20, 20, 19, 0.88) 0%, rgba(20, 20, 19, 0) 35%);
        }

        .dashboard-shell {
            position: relative;
        }

        .dashboard-shell::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                -24deg,
                rgba(148, 163, 184, 0.06) 0,
                rgba(148, 163, 184, 0.06) 1px,
                transparent 1px,
                transparent 14px
            );
            mix-blend-mode: multiply;
            opacity: 0.35;
        }

        h1, h2, h3, .btn, .badge {
            font-family: 'Poppins', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .progress-bar {
            background-color: var(--bg-tertiary);
            border-radius: 9999px;
            overflow: hidden;
            height: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        .input-field {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s ease;
        }

        .secret-obscured {
            -webkit-text-security: disc;
            text-security: disc;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 162, 76, 0.18);
        }

        .btn {
            background-color: var(--accent-color);
            color: var(--claude-ink);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 8px 20px rgba(212, 162, 76, 0.22);
        }

        .btn:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .account-tab {
            padding: 0.35rem 0.8rem;
            border-radius: 0.65rem;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .account-tab:hover {
            border-color: rgba(212, 162, 76, 0.5);
        }

        .account-tab-active {
            background: linear-gradient(135deg, var(--accent-color), #e2ba70);
            color: var(--claude-ink);
            border-color: transparent;
            box-shadow: 0 6px 16px rgba(212, 162, 76, 0.28);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-lite { background-color: #e8e6dc; color: #4a463f; }
        .badge-pro { background-color: #f3e5c7; color: #8f6a2e; }
        .badge-max { background-color: #f4d9cf; color: #a24f38; }
        .badge-metered { background-color: #e9f1e8; color: #4f6f3f; }
        [data-theme="dark"] .badge-lite { background-color: #3d3a35; color: #d1cec4; }
        [data-theme="dark"] .badge-pro { background-color: #4b3d25; color: #f6cf7c; }
        [data-theme="dark"] .badge-max { background-color: #57362d; color: #f0a58b; }
        [data-theme="dark"] .badge-metered { background-color: #2f3c2a; color: #b8d39f; }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-success { background-color: var(--success-color); }
        .status-warning { background-color: var(--warning-color); }
        .status-danger { background-color: var(--danger-color); }

        .chart-wrap {
            position: relative;
            min-height: 220px;
        }

        .chart-wrap-sm {
            position: relative;
            min-height: 180px;
        }

        .viz-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.65rem;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .claude-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.22rem 0.7rem;
            border-radius: 999px;
            background-color: var(--claude-yellow-soft);
            border: 1px solid rgba(212, 162, 76, 0.45);
            color: var(--claude-ink);
            font-size: 0.72rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.02em;
        }

        .claude-badge::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--claude-yellow);
            box-shadow: 0 0 0 4px rgba(212, 162, 76, 0.2);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 8px;
            margin-top: 0.5rem;
        }

        .heat-cell {
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }

        .heat-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.22);
        }

        .heat-legend {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 0.65rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .heat-bar {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(212,162,76,0.12), rgba(212,162,76,0.9));
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8 dashboard-shell">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <svg class="w-8 h-8" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    å¤šå¹³å° LLM ç”¨é‡ä»ªè¡¨ç›˜
                    <span class="claude-badge">Claude Yellow</span>
                </h1>
                <p class="text-sm mt-1" style="color: var(--text-secondary)">ç»Ÿä¸€æŸ¥çœ‹ GLM / OpenAI / Anthropic / DeepSeek çš„ç”¨é‡ä¸æˆæœ¬</p>
            </div>
            <div class="flex items-center gap-3">
                <span id="lastUpdate" class="text-sm" style="color: var(--text-secondary)"></span>
                <button id="refreshBtn" class="btn btn-secondary flex items-center gap-2" onclick="refreshData()">
                    <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    åˆ·æ–°
                </button>
                <button class="btn btn-secondary p-2" onclick="toggleTheme()" data-tooltip="åˆ‡æ¢ä¸»é¢˜">
                    <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </button>
                <button class="btn btn-secondary p-2" onclick="toggleSettings()" data-tooltip="è®¾ç½®">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- API Key Input Section -->
        <section id="apiKeySection" class="card mb-6 fade-in">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
                API Key ç®¡ç†
            </h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">
                            æŸ¥è¯¢å¹³å°
                        </label>
                        <select id="platformSelect" class="input-field" onchange="changePlatform()"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">
                            é‰´æƒè¯´æ˜
                        </label>
                        <div id="platformAuthHint" class="p-3 rounded-lg text-sm" style="background-color: var(--bg-tertiary); color: var(--text-secondary)">
                            --
                        </div>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label id="apiKeyLabel" class="block text-sm font-medium" style="color: var(--text-secondary)">
                            è¾“å…¥ API Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰
                        </label>
                        <button id="toggleApiInputBtn" class="btn btn-secondary py-1 px-3 text-xs" onclick="toggleApiInputVisibility()" type="button">
                            æ˜¾ç¤ºæ˜æ–‡
                        </button>
                    </div>
                    <textarea id="apiKeyInput" class="input-field h-24 font-mono text-sm secret-obscured" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="è¯·è¾“å…¥ API Keyï¼Œæ”¯æŒæ¯è¡Œä¸€ä¸ªç”¨äºå¤šè´¦æˆ·å¯¹æ¯”"></textarea>
                </div>
                <div id="platformEndpointHint" class="text-xs" style="color: var(--text-secondary)"></div>
                <div class="flex items-center gap-4">
                    <button id="saveKeyBtn" class="btn" onclick="saveApiKeys()">ä¿å­˜å¹¶æŸ¥è¯¢</button>
                    <button class="btn btn-secondary" onclick="clearApiKeys()">æ¸…é™¤æ‰€æœ‰</button>
                    <span id="keyStatus" class="text-sm" style="color: var(--text-secondary)"></span>
                </div>
            </div>
        </section>

        <!-- Settings Panel (Hidden by default) -->
        <section id="settingsPanel" class="card mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">è®¾ç½®</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">
                        è‡ªåŠ¨åˆ·æ–°é—´éš”
                    </label>
                    <select id="refreshInterval" class="input-field" onchange="updateRefreshInterval()">
                        <option value="0">ç¦ç”¨</option>
                        <option value="30000">30 ç§’</option>
                        <option value="60000" selected>1 åˆ†é’Ÿ</option>
                        <option value="300000">5 åˆ†é’Ÿ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">
                        CORS ä»£ç†
                    </label>
                    <select id="corsProxy" class="input-field" onchange="saveSettings()">
                        <option value="corsproxy">corsproxy.ioï¼ˆæ–‡ä»¶ç›´å¼€å¯è¯•ï¼‰</option>
                        <option value="allorigins">allorigins.win</option>
                        <option value="none">ä¸ä½¿ç”¨ä»£ç†ï¼ˆLive Server æ¨èï¼‰</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="saveHistory" class="w-4 h-4 rounded" checked onchange="saveSettings()">
                        <span class="text-sm">ä¿å­˜å†å²è®°å½•ä»¥æ˜¾ç¤ºè¶‹åŠ¿å›¾</span>
                    </label>
                </div>
                <div class="md:col-span-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="autoFillApiKeys" class="w-4 h-4 rounded" onchange="saveSettings(); loadApiKeys()">
                        <span class="text-sm">è‡ªåŠ¨å›å¡« API Key åˆ°è¾“å…¥æ¡†ï¼ˆä¸å»ºè®®å…¬å…±ç¯å¢ƒå¼€å¯ï¼‰</span>
                    </label>
                </div>
                <div class="md:col-span-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="maskApiInput" class="w-4 h-4 rounded" checked onchange="saveSettings(); applyApiInputMask()">
                        <span class="text-sm">éšè— API Key è¾“å…¥ï¼ˆé˜²è‚©çª¥ï¼‰</span>
                    </label>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">
                        API Key å­˜å‚¨æ¨¡å¼
                    </label>
                    <select id="keyStorageMode" class="input-field" onchange="saveSettings(); handleKeyStorageModeChange()">
                        <option value="local">æœ¬åœ°é•¿æœŸï¼ˆlocalStorageï¼‰</option>
                        <option value="session">ä»…å½“å‰ä¼šè¯ï¼ˆsessionStorageï¼‰</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Error Message -->
        <div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="errorMessage"></span>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Account Selector (for multiple keys) -->
            <div id="accountSelector" class="card mb-6 hidden">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="text-sm font-medium" style="color: var(--text-secondary)">é€‰æ‹©è´¦æˆ·:</span>
                    <div id="accountTabs" class="flex gap-2 flex-wrap"></div>
                    <button class="btn btn-secondary py-1 px-3 text-xs" onclick="resetCurrentAccountTracking()">
                        é‡ç½®å½“å‰è´¦æˆ·è¿½è¸ª
                    </button>
                </div>
                <div id="accountTrackingHint" class="text-xs mt-2" style="color: var(--text-secondary)"></div>
            </div>

            <div id="platformMetaCard" class="card mb-6 hidden">
                <h3 class="text-lg font-semibold mb-3">å¹³å°æ¥å£è¯¦æƒ…</h3>
                <div id="platformMetaBody" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></div>
            </div>

            <!-- Main Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Plan Type Card -->
                <div class="card fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium" style="color: var(--text-secondary)">å½“å‰å¥—é¤</span>
                        <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="planBadge" class="badge badge-pro">Pro</span>
                        <span id="planExpiry" class="text-sm" style="color: var(--text-secondary)"></span>
                    </div>
                </div>

                <!-- 5-Hour Cycle Card -->
                <div class="card fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium" style="color: var(--text-secondary)">5å°æ—¶å‘¨æœŸ</span>
                        <svg class="w-5 h-5" style="color: var(--success-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <span id="cycleUsed" class="text-2xl font-bold">0</span>
                        <span class="text-sm" style="color: var(--text-secondary)"> / <span id="cycleTotal">0</span></span>
                    </div>
                    <div class="progress-bar">
                        <div id="cycleProgress" class="progress-fill" style="background-color: var(--success-color); width: 0%"></div>
                    </div>
                    <div class="mt-2 text-xs" style="color: var(--text-secondary)">
                        å‘¨æœŸé‡ç½®: <span id="cycleReset">--</span>
                    </div>
                </div>

                <!-- Weekly Quota Card -->
                <div class="card fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium" style="color: var(--text-secondary)">æ¯å‘¨é¢åº¦</span>
                        <svg class="w-5 h-5" style="color: var(--warning-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="mb-2">
                        <span id="weeklyPercent" class="text-2xl font-bold">0%</span>
                        <span class="text-sm" style="color: var(--text-secondary)"> å·²ä½¿ç”¨</span>
                    </div>
                    <div class="progress-bar">
                        <div id="weeklyProgress" class="progress-fill" style="background-color: var(--warning-color); width: 0%"></div>
                    </div>
                    <div class="mt-2 text-xs" style="color: var(--text-secondary)">
                        é‡ç½®æ—¶é—´: <span id="weeklyReset">--</span>
                    </div>
                </div>

                <!-- Account Status Card -->
                <div class="card fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium" style="color: var(--text-secondary)">è´¦æˆ·çŠ¶æ€</span>
                        <svg class="w-5 h-5" style="color: var(--success-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <span id="statusDot" class="status-dot status-success"></span>
                            <span id="statusText" class="text-sm">æ­£å¸¸</span>
                        </div>
                        <div class="text-xs" style="color: var(--text-secondary)">
                            24h Token ç”¨é‡: <span id="accountBalance" class="font-medium">--</span>
                        </div>
                        <div class="text-xs" style="color: var(--text-secondary)">
                            24h è°ƒç”¨æ¬¡æ•°: <span id="accountCalls" class="font-medium">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Balances & MCP Tools -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Model Balances -->
                <div class="card fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        æ¨¡å‹ç”¨é‡æ¦‚è§ˆ
                    </h3>
                    <div id="modelBalances" class="space-y-4">
                        <div class="text-center py-8" style="color: var(--text-secondary)">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>

                <!-- MCP Tools -->
                <div class="card fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        MCP å·¥å…·é¢åº¦
                    </h3>
                    <div id="mcpTools" class="space-y-4">
                        <div class="text-center py-8" style="color: var(--text-secondary)">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visual Analytics -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                <div class="card fade-in">
                    <h3 class="text-lg font-semibold mb-3">é¢åº¦ç»“æ„</h3>
                    <div class="flex items-center gap-2 mb-3">
                        <span id="quotaCycleChip" class="viz-chip">Cycle --%</span>
                        <span id="quotaWeeklyChip" class="viz-chip">Week --%</span>
                    </div>
                    <div class="chart-wrap-sm">
                        <canvas id="quotaRingChart"></canvas>
                    </div>
                </div>
                <div class="card fade-in">
                    <h3 class="text-lg font-semibold mb-3">MCP å·¥å…·åˆ†å¸ƒ</h3>
                    <div class="chart-wrap-sm">
                        <canvas id="mcpBarChart"></canvas>
                    </div>
                </div>
                <div class="card fade-in">
                    <h3 class="text-lg font-semibold mb-2">24h çƒ­åŠ›çŸ©é˜µ</h3>
                    <div class="text-xs mb-2" style="color: var(--text-secondary)">
                        æ¯æ ¼ä»£è¡¨ä¸€å°æ—¶ Token æ´»è·ƒå¼ºåº¦
                    </div>
                    <div id="hourlyHeatmap" class="heatmap-grid"></div>
                    <div class="heat-legend">
                        <span>ä½</span>
                        <div class="heat-bar"></div>
                        <span>é«˜</span>
                    </div>
                    <div class="mt-2 text-xs" style="color: var(--text-secondary)">
                        å³°å€¼: <span id="heatmapPeak" class="font-semibold">--</span> Â·
                        å‡å€¼: <span id="heatmapAvg" class="font-semibold">--</span>
                    </div>
                </div>
            </div>

            <!-- Account Delta Compare -->
            <div class="card fade-in mb-6">
                <h3 class="text-lg font-semibold mb-2">å¤šè´¦æˆ·å¢é‡å¯¹æ¯”ï¼ˆæœ¬åœ°è¿½è¸ªï¼‰</h3>
                <div class="chart-wrap-sm">
                    <canvas id="accountCompareChart"></canvas>
                </div>
                <div id="accountCompareHint" class="text-xs mt-2" style="color: var(--text-secondary)">
                    åˆ‡æ¢è´¦æˆ·å¹¶åˆ·æ–°åï¼Œå°†è‡ªåŠ¨æ›´æ–°å¯¹æ¯”å›¾ã€‚
                </div>
            </div>

            <!-- Usage Trend Chart -->
            <div class="card fade-in mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    ç”¨é‡è¶‹åŠ¿ï¼ˆæœ€è¿‘ 24 å°æ—¶ï¼‰
                </h3>
                <div class="chart-wrap">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Detailed Usage Table -->
            <div class="card fade-in">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    è¯¦ç»†ç”¨é‡ä¿¡æ¯
                </h3>
                <div id="detailedUsage" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color)">
                                <th class="text-left py-3 px-4 font-medium" style="color: var(--text-secondary)">é¡¹ç›®</th>
                                <th class="text-right py-3 px-4 font-medium" style="color: var(--text-secondary)">å·²ç”¨</th>
                                <th class="text-right py-3 px-4 font-medium" style="color: var(--text-secondary)">æ€»é‡</th>
                                <th class="text-right py-3 px-4 font-medium" style="color: var(--text-secondary)">å‰©ä½™</th>
                                <th class="text-left py-3 px-4 font-medium" style="color: var(--text-secondary)">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="usageTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-8" style="color: var(--text-secondary)">
                                    åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <svg class="w-12 h-12 mx-auto mb-4 loading-spinner" style="color: var(--accent-color)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <p style="color: var(--text-secondary)">æ­£åœ¨è·å–ç”¨é‡æ•°æ®...</p>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-sm" style="color: var(--text-secondary)">
            <p id="footerSource">æ•°æ®æ¥æº: å¤šå¹³å°å®˜æ–¹ API | æœ¬ä»ªè¡¨ç›˜ä¸å­˜å‚¨æ‚¨çš„ API Key åˆ°è¿œç¨‹æœåŠ¡å™¨</p>
            <p class="mt-1">å»ºè®®ä½¿ç”¨ VS Code Live Server ä»¥è·å¾—æœ€ä½³ä½“éªŒ</p>
        </footer>
    </div>

    <script>
        // ==================== Configuration ====================
        const CONFIG = {
            corsProxies: {
                corsproxy: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                allorigins: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                none: (url) => url
            },
            planLimits: {
                lite: { cycleMax: 100, weeklyMax: 2000 },
                pro: { cycleMax: 400, weeklyMax: 10000 },
                max: { cycleMax: 1000, weeklyMax: 50000 }
            },
            defaultModels: [
                { id: 'glm-4-plus', name: 'GLM-4-Plus', color: '#d4a24c' },
                { id: 'glm-4-0520', name: 'GLM-4-0520', color: '#d97757' },
                { id: 'glm-4-air', name: 'GLM-4-Air', color: '#6a9bcc' },
                { id: 'glm-4-airx', name: 'GLM-4-AirX', color: '#788c5d' },
                { id: 'glm-4-flash', name: 'GLM-4-Flash', color: '#e39c3f' },
                { id: 'glm-4v', name: 'GLM-4V', color: '#9f6c63' }
            ],
            defaultMcpTools: [
                { id: 'web_search', name: 'è”ç½‘æœç´¢', icon: 'ğŸ”' },
                { id: 'web_reader', name: 'ç½‘é¡µè¯»å–', icon: 'ğŸ“„' },
                { id: 'vision', name: 'è§†è§‰ç†è§£', icon: 'ğŸ‘ï¸' }
            ],
            platforms: {
                glm: {
                    id: 'glm',
                    name: 'GLM / Z.AI',
                    sourceLabel: 'GLM OpenAPI',
                    keyLabel: 'è¾“å…¥ GLM API Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰',
                    keyPlaceholder: 'è¯·è¾“å…¥ GLM API Key...\næ ¼å¼: xxxxxxxx.xxxxxxxxxxxx\næ”¯æŒåŒæ—¶æŸ¥è¯¢å¤šä¸ªè´¦æˆ·',
                    authHint: 'Bearer Tokenï¼ˆå¯ç›´æ¥å¡« keyï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¡¥å…¨ Bearerï¼‰',
                    endpointHint: 'æ¥å£: /api/monitor/usage/model-usage, /tool-usage, /quota/limit',
                    supports: { cycleQuota: true, weeklyQuota: true, mcp: true },
                    baseUrls: ['https://open.bigmodel.cn', 'https://api.z.ai'],
                    apiEndpoints: {
                        modelUsage: '/api/monitor/usage/model-usage',
                        toolUsage: '/api/monitor/usage/tool-usage',
                        quotaLimit: '/api/monitor/usage/quota/limit'
                    },
                    models: [
                        { id: 'glm-4-plus', name: 'GLM-4-Plus', color: '#d4a24c' },
                        { id: 'glm-4-0520', name: 'GLM-4-0520', color: '#d97757' },
                        { id: 'glm-4-air', name: 'GLM-4-Air', color: '#6a9bcc' },
                        { id: 'glm-4-airx', name: 'GLM-4-AirX', color: '#788c5d' },
                        { id: 'glm-4-flash', name: 'GLM-4-Flash', color: '#e39c3f' },
                        { id: 'glm-4v', name: 'GLM-4V', color: '#9f6c63' }
                    ],
                    mcpTools: [
                        { id: 'web_search', name: 'è”ç½‘æœç´¢', icon: 'ğŸ”' },
                        { id: 'web_reader', name: 'ç½‘é¡µè¯»å–', icon: 'ğŸ“„' },
                        { id: 'vision', name: 'è§†è§‰ç†è§£', icon: 'ğŸ‘ï¸' }
                    ],
                    validateKey: (key) => key.length >= 20 && /^[a-zA-Z0-9._-]+$/.test(key)
                },
                openai: {
                    id: 'openai',
                    name: 'OpenAI',
                    sourceLabel: 'OpenAI Organization Usage API',
                    keyLabel: 'è¾“å…¥ OpenAI Admin Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰',
                    keyPlaceholder: 'è¯·è¾“å…¥ OpenAI Admin API Key...\nå»ºè®®æ ¼å¼: sk-...\nä»…ç»„ç»‡ç®¡ç†å‘˜å¯æŸ¥è¯¢ usage/cost',
                    authHint: 'Bearer Admin Keyï¼ˆéœ€ç»„ç»‡ç®¡ç†å‘˜æƒé™ï¼‰',
                    endpointHint: 'æ¥å£: /v1/organization/usage/completions + /v1/organization/costs',
                    supports: { cycleQuota: false, weeklyQuota: false, mcp: false },
                    baseUrl: 'https://api.openai.com/v1',
                    models: [
                        { id: 'gpt-5', name: 'GPT-5', color: '#d4a24c' },
                        { id: 'gpt-4.1', name: 'GPT-4.1', color: '#d97757' },
                        { id: 'o3', name: 'o3', color: '#788c5d' },
                        { id: 'gpt-4o', name: 'GPT-4o', color: '#6a9bcc' }
                    ],
                    mcpTools: [],
                    validateKey: (key) => key.length >= 20 && /^sk-[a-zA-Z0-9._-]+$/.test(key)
                },
                anthropic: {
                    id: 'anthropic',
                    name: 'Anthropic',
                    sourceLabel: 'Anthropic Admin Usage API',
                    keyLabel: 'è¾“å…¥ Anthropic Admin Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰',
                    keyPlaceholder: 'è¯·è¾“å…¥ Anthropic Admin Key...\nå»ºè®®æ ¼å¼: sk-ant-admin-...\nä»…ç»„ç»‡ç®¡ç†å‘˜å¯æŸ¥è¯¢ Usage/Cost Report',
                    authHint: 'x-api-key + anthropic-version å¤´ï¼ˆAdmin Keyï¼‰',
                    endpointHint: 'æ¥å£: /v1/organizations/usage_report/messages + /v1/organizations/cost_report',
                    supports: { cycleQuota: false, weeklyQuota: false, mcp: true },
                    baseUrl: 'https://api.anthropic.com/v1',
                    models: [
                        { id: 'claude-opus-4-1', name: 'Claude Opus 4.1', color: '#d4a24c' },
                        { id: 'claude-sonnet-4-5', name: 'Claude Sonnet 4.5', color: '#d97757' },
                        { id: 'claude-3-7-sonnet', name: 'Claude 3.7 Sonnet', color: '#788c5d' }
                    ],
                    mcpTools: [
                        { id: 'web_search', name: 'Web Search', icon: 'ğŸ”' },
                        { id: 'code_execution', name: 'Code Exec', icon: 'ğŸ§ª' },
                        { id: 'web_fetch', name: 'Web Fetch', icon: 'ğŸ“„' }
                    ],
                    validateKey: (key) => key.length >= 24 && /^sk-ant-[a-zA-Z0-9._-]+$/.test(key)
                },
                deepseek: {
                    id: 'deepseek',
                    name: 'DeepSeek',
                    sourceLabel: 'DeepSeek Open Platform',
                    keyLabel: 'è¾“å…¥ DeepSeek API Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰',
                    keyPlaceholder: 'è¯·è¾“å…¥ DeepSeek API Key...\nå»ºè®®æ ¼å¼: sk-...\nå½“å‰å®˜æ–¹å…¬å¼€ä½™é¢æ¥å£ä¸º /user/balance',
                    authHint: 'Bearer Keyï¼ˆå…¬å¼€å¯æŸ¥ä½™é¢ï¼Œè¯¦å•é€šå¸¸åœ¨æ§åˆ¶å°ï¼‰',
                    endpointHint: 'æ¥å£: /user/balanceï¼ˆä½™é¢ï¼‰+ æœ¬åœ°å¢é‡è¿½è¸ª',
                    supports: { cycleQuota: false, weeklyQuota: false, mcp: false },
                    baseUrl: 'https://api.deepseek.com',
                    models: [
                        { id: 'balance_total', name: 'è´¦æˆ·ä½™é¢', color: '#d4a24c' },
                        { id: 'deepseek-chat', name: 'DeepSeek Chat', color: '#d4a24c' },
                        { id: 'deepseek-reasoner', name: 'DeepSeek Reasoner', color: '#788c5d' }
                    ],
                    mcpTools: [],
                    validateKey: (key) => key.length >= 20 && /^sk-[a-zA-Z0-9._-]+$/.test(key)
                },
                stepfun: {
                    id: 'stepfun',
                    name: 'StepFun',
                    sourceLabel: 'StepFun OpenAPI',
                    keyLabel: 'è¾“å…¥ StepFun API Keyï¼ˆæ”¯æŒå¤šä¸ª Keyï¼Œæ¯è¡Œä¸€ä¸ªï¼‰',
                    keyPlaceholder: 'è¯·è¾“å…¥ StepFun API Key...\nå»ºè®®æ ¼å¼: sk-...\nå½“å‰å…¬å¼€å¯æŸ¥è´¦æˆ·ä½™é¢æ¥å£ /v1/accounts',
                    authHint: 'Bearer Keyï¼ˆå¯æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸è´¦æˆ·ä¿¡æ¯ï¼‰',
                    endpointHint: 'æ¥å£: /v1/accountsï¼ˆä½™é¢ï¼‰+ /v1/modelsï¼ˆæ¨¡å‹åˆ—è¡¨ï¼‰',
                    supports: { cycleQuota: false, weeklyQuota: false, mcp: false },
                    baseUrl: 'https://api.stepfun.com/v1',
                    models: [
                        { id: 'balance_total', name: 'è´¦æˆ·ä½™é¢', color: '#d4a24c' },
                        { id: 'step-2', name: 'Step-2', color: '#d97757' },
                        { id: 'step-1v', name: 'Step-1V', color: '#788c5d' },
                        { id: 'step-1-flash', name: 'Step-1 Flash', color: '#6a9bcc' }
                    ],
                    mcpTools: [],
                    validateKey: (key) => key.length >= 20 && /^sk-[a-zA-Z0-9._-]+$/.test(key)
                }
            }
        };

        // ==================== State Management ====================
        let state = {
            platformId: 'glm',
            apiKeys: [],
            currentKeyIndex: 0,
            data: {},
            accountData: {},
            keyTracking: {},
            refreshTimer: null,
            chart: null,
            quotaChart: null,
            mcpChart: null,
            accountChart: null,
            requestId: 0
        };

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', () => {
            initPlatformSelector();
            loadSettings();
            initChart();
            initVisualCharts();
            initTheme();
            updateRefreshInterval(false);
            loadApiKeys();
        });

        function getPlatformConfig(platformId = state.platformId) {
            return CONFIG.platforms[platformId] || CONFIG.platforms.glm;
        }

        function getStorageKey(name) {
            return `llm_dashboard_${state.platformId}_${name}`;
        }

        function getHistoryStorageKey() {
            return getStorageKey('history');
        }

        function getActiveModels() {
            return getPlatformConfig().models || CONFIG.defaultModels;
        }

        function getActiveMcpTools() {
            const tools = getPlatformConfig().mcpTools;
            return Array.isArray(tools) ? tools : CONFIG.defaultMcpTools;
        }

        function initPlatformSelector() {
            const selector = document.getElementById('platformSelect');
            const entries = Object.values(CONFIG.platforms);
            selector.innerHTML = entries.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
            state.platformId = localStorage.getItem('llm_dashboard_platform') || 'glm';
            if (!CONFIG.platforms[state.platformId]) {
                state.platformId = 'glm';
            }
            selector.value = state.platformId;
            applyPlatformMeta();
        }

        function applyPlatformMeta() {
            const platform = getPlatformConfig();
            const label = document.getElementById('apiKeyLabel');
            const input = document.getElementById('apiKeyInput');
            const authHint = document.getElementById('platformAuthHint');
            const endpointHint = document.getElementById('platformEndpointHint');
            const source = document.getElementById('footerSource');

            label.textContent = platform.keyLabel;
            input.placeholder = platform.keyPlaceholder;
            authHint.textContent = platform.authHint;
            endpointHint.textContent = `æ•°æ®æ¥å£: ${platform.endpointHint}`;
            source.textContent = `æ•°æ®æ¥æº: ${platform.sourceLabel} | æœ¬ä»ªè¡¨ç›˜ä¸å­˜å‚¨æ‚¨çš„ API Key åˆ°è¿œç¨‹æœåŠ¡å™¨`;
            applyApiInputMask();
        }

        function changePlatform() {
            const nextPlatform = document.getElementById('platformSelect').value;
            if (!CONFIG.platforms[nextPlatform]) return;

            state.platformId = nextPlatform;
            state.apiKeys = [];
            state.currentKeyIndex = 0;
            state.data = {};
            state.accountData = {};
            state.keyTracking = {};
            state.requestId = 0;
            localStorage.setItem('llm_dashboard_platform', nextPlatform);

            applyPlatformMeta();
            document.getElementById('dashboardContent').classList.add('hidden');
            hideError();
            updateKeyStatus('');
            loadApiKeys();
        }

        function getDashboardSettings() {
            const parsed = JSON.parse(
                localStorage.getItem('llm_dashboard_settings') ||
                localStorage.getItem('glm_settings') ||
                '{}'
            );
            const defaultProxy = window.location.protocol === 'file:' ? 'corsproxy' : 'none';
            return {
                refreshInterval: parsed.refreshInterval || '60000',
                corsProxy: parsed.corsProxy || defaultProxy,
                saveHistory: parsed.saveHistory !== false,
                autoFillApiKeys: parsed.autoFillApiKeys === true,
                maskApiInput: parsed.maskApiInput !== false,
                keyStorageMode: parsed.keyStorageMode === 'session' ? 'session' : 'local'
            };
        }

        function getKeyStorageArea(mode = null) {
            const settings = getDashboardSettings();
            const finalMode = mode || document.getElementById('keyStorageMode')?.value || settings.keyStorageMode;
            return finalMode === 'session' ? sessionStorage : localStorage;
        }

        function getSecondaryKeyStorageArea() {
            return getKeyStorageArea() === localStorage ? sessionStorage : localStorage;
        }

        function getLegacyStorageKey(name) {
            if (state.platformId !== 'glm') return null;
            if (name === 'api_keys') return 'glm_api_keys';
            if (name === 'key_tracking') return 'glm_key_tracking';
            return null;
        }

        function readKeyStoreValue(name, fallback = '{}') {
            const primary = getKeyStorageArea();
            const key = getStorageKey(name);
            let value = primary.getItem(key);
            if (value === null && primary === localStorage) {
                const legacyKey = getLegacyStorageKey(name);
                if (legacyKey) value = localStorage.getItem(legacyKey);
            }
            return value === null ? fallback : value;
        }

        function writeKeyStoreValue(name, value) {
            const key = getStorageKey(name);
            const primary = getKeyStorageArea();
            const secondary = getSecondaryKeyStorageArea();
            primary.setItem(key, value);
            secondary.removeItem(key);
        }

        function removeKeyStoreValue(name) {
            const key = getStorageKey(name);
            localStorage.removeItem(key);
            sessionStorage.removeItem(key);
            const legacyKey = getLegacyStorageKey(name);
            if (legacyKey) {
                localStorage.removeItem(legacyKey);
            }
        }

        function applyApiInputMask(forceValue = null) {
            const input = document.getElementById('apiKeyInput');
            const checkbox = document.getElementById('maskApiInput');
            const button = document.getElementById('toggleApiInputBtn');
            if (!input || !checkbox || !button) return;

            const shouldMask = forceValue === null ? checkbox.checked : Boolean(forceValue);
            checkbox.checked = shouldMask;
            input.classList.toggle('secret-obscured', shouldMask);
            button.textContent = shouldMask ? 'æ˜¾ç¤ºæ˜æ–‡' : 'éšè—æ˜æ–‡';
        }

        function toggleApiInputVisibility() {
            const checkbox = document.getElementById('maskApiInput');
            if (!checkbox) return;
            checkbox.checked = !checkbox.checked;
            applyApiInputMask();
            saveSettings();
        }

        function handleKeyStorageModeChange() {
            state.apiKeys = [];
            state.currentKeyIndex = 0;
            state.accountData = {};
            state.keyTracking = {};
            state.requestId = 0;
            loadApiKeys();
        }

        function loadSettings() {
            const settings = getDashboardSettings();
            document.getElementById('refreshInterval').value = settings.refreshInterval;
            document.getElementById('corsProxy').value = settings.corsProxy;
            document.getElementById('saveHistory').checked = settings.saveHistory;
            document.getElementById('autoFillApiKeys').checked = settings.autoFillApiKeys;
            document.getElementById('maskApiInput').checked = settings.maskApiInput;
            document.getElementById('keyStorageMode').value = settings.keyStorageMode;
            applyApiInputMask(settings.maskApiInput);
        }

        function saveSettings() {
            const settings = {
                refreshInterval: document.getElementById('refreshInterval').value,
                corsProxy: document.getElementById('corsProxy').value,
                saveHistory: document.getElementById('saveHistory').checked,
                autoFillApiKeys: document.getElementById('autoFillApiKeys').checked,
                maskApiInput: document.getElementById('maskApiInput').checked,
                keyStorageMode: document.getElementById('keyStorageMode').value
            };
            localStorage.setItem('llm_dashboard_settings', JSON.stringify(settings));
            applyApiInputMask(settings.maskApiInput);
        }

        function loadKeyTracking() {
            const storageValue = readKeyStoreValue('key_tracking', '{}');
            const raw = JSON.parse(storageValue);
            state.keyTracking = raw && typeof raw === 'object' ? raw : {};
            pruneKeyTracking();
        }

        function saveKeyTracking() {
            writeKeyStoreValue('key_tracking', JSON.stringify(state.keyTracking));
        }

        function pruneKeyTracking() {
            const keySet = new Set(state.apiKeys);
            const next = {};
            Object.entries(state.keyTracking).forEach(([key, value]) => {
                if (keySet.has(key)) {
                    next[key] = value;
                }
            });
            state.keyTracking = next;
        }

        function loadApiKeys() {
            const storageValue = readKeyStoreValue('api_keys', '[]');
            const keys = JSON.parse(storageValue);
            state.apiKeys = keys;
            state.accountData = {};
            state.currentKeyIndex = 0;
            state.requestId = 0;
            loadKeyTracking();

            if (keys.length > 0) {
                const autoFill = document.getElementById('autoFillApiKeys').checked;
                document.getElementById('apiKeyInput').value = autoFill ? keys.join('\n') : '';
                updateKeyStatus(
                    autoFill
                        ? `${getPlatformConfig().name}: ${keys.length} ä¸ª API Key å·²ä¿å­˜`
                        : `${getPlatformConfig().name}: å·²åŠ è½½ ${keys.length} ä¸ª API Keyï¼ˆæœªè‡ªåŠ¨å›å¡«ï¼‰`
                );
                refreshData();
            } else {
                document.getElementById('apiKeyInput').value = '';
                updateKeyStatus('');
            }
            applyApiInputMask();
        }

        function saveApiKeys() {
            const input = document.getElementById('apiKeyInput').value;
            const keys = input.split('\n')
                .map(k => k.trim())
                .filter(k => k.length > 0);

            const platform = getPlatformConfig();
            const validKeys = keys.filter(k => {
                const normalized = k.startsWith('Bearer ') ? k.slice(7).trim() : k;
                if (typeof platform.validateKey === 'function') {
                    return platform.validateKey(normalized);
                }
                return normalized.length >= 20 && /^[a-zA-Z0-9._-]+$/.test(normalized);
            });

            if (validKeys.length === 0) {
                showError(`è¯·è¾“å…¥æœ‰æ•ˆçš„ ${platform.name} API Key`);
                return;
            }

            const invalidCount = keys.length - validKeys.length;
            if (invalidCount > 0) {
                console.warn(`${invalidCount} ä¸ªæ— æ•ˆçš„ Key å·²è¢«å¿½ç•¥`);
            }

            state.apiKeys = validKeys;
            state.currentKeyIndex = 0;
            state.accountData = {};
            state.requestId = 0;
            pruneKeyTracking();
            saveKeyTracking();
            writeKeyStoreValue('api_keys', JSON.stringify(validKeys));
            updateKeyStatus(`${platform.name}: å·²ä¿å­˜ ${validKeys.length} ä¸ª API Key`);
            if (!document.getElementById('autoFillApiKeys').checked) {
                document.getElementById('apiKeyInput').value = '';
            }
            hideError();

            refreshData();
        }

        function clearApiKeys() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„ API Key å—ï¼Ÿ')) {
                state.apiKeys = [];
                state.currentKeyIndex = 0;
                state.accountData = {};
                state.keyTracking = {};
                state.requestId = 0;
                removeKeyStoreValue('api_keys');
                removeKeyStoreValue('key_tracking');
                localStorage.removeItem(getHistoryStorageKey());
                if (state.platformId === 'glm') localStorage.removeItem('glm_history');
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('dashboardContent').classList.add('hidden');
                updateKeyStatus(`${getPlatformConfig().name}: å·²æ¸…é™¤æ‰€æœ‰ API Key`);
            }
        }

        function updateKeyStatus(message) {
            document.getElementById('keyStatus').textContent = message;
        }

        function maskApiKey(key) {
            const normalized = String(key || '').trim();
            if (!normalized) return 'æœªçŸ¥';
            if (normalized.length <= 10) return normalized;
            return `${normalized.slice(0, 6)}...${normalized.slice(-4)}`;
        }

        function buildTrackingSnapshot(data) {
            return {
                tokens: Number(data?.modelSummary?.totalTokens24h || 0),
                calls: Number(data?.modelSummary?.totalCalls24h || 0),
                mcp: Number(data?.mcpUsage?.shared?.used || 0),
                cycle: Number(data?.plan?.cycleUsed || 0),
                weekly: Number(data?.weekly?.used || 0),
                ts: Date.now()
            };
        }

        function buildTrackingDelta(baseline, current) {
            const diff = (a, b) => {
                const x = Number(a || 0);
                const y = Number(b || 0);
                return x >= y ? (x - y) : 0;
            };
            return {
                tokens: diff(current.tokens, baseline.tokens),
                calls: diff(current.calls, baseline.calls),
                mcp: diff(current.mcp, baseline.mcp),
                cycle: diff(current.cycle, baseline.cycle),
                weekly: diff(current.weekly, baseline.weekly)
            };
        }

        function upsertKeyTracking(apiKey, data) {
            if (!apiKey || !data) return;
            const snapshot = buildTrackingSnapshot(data);
            const existing = state.keyTracking[apiKey];
            if (!existing || !existing.baseline) {
                state.keyTracking[apiKey] = {
                    baseline: snapshot,
                    latest: snapshot,
                    delta: { tokens: 0, calls: 0, mcp: 0, cycle: 0, weekly: 0 },
                    updatedAt: Date.now()
                };
            } else {
                const baseline = existing.baseline;
                const delta = buildTrackingDelta(baseline, snapshot);
                state.keyTracking[apiKey] = {
                    baseline,
                    latest: snapshot,
                    delta,
                    updatedAt: Date.now()
                };
            }
            saveKeyTracking();
        }

        function getKeyTracking(apiKey) {
            if (!apiKey) return null;
            return state.keyTracking[apiKey] || null;
        }

        // ==================== API Calls ====================
        function getCorsProxyUrl(url) {
            const proxyType = document.getElementById('corsProxy').value;
            return CONFIG.corsProxies[proxyType](url);
        }

        function formatApiDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function getLast24HourWindow() {
            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, now.getHours(), 0, 0, 0);
            const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), 59, 59, 999);
            return {
                startTime: formatApiDateTime(startDate),
                endTime: formatApiDateTime(endDate)
            };
        }

        function buildUrlWithQuery(baseUrl, endpoint, query = null) {
            const url = `${baseUrl}${endpoint}`;
            if (!query || Object.keys(query).length === 0) {
                return url;
            }
            const params = new URLSearchParams();
            Object.entries(query).forEach(([key, value]) => {
                if (value !== null && value !== undefined && value !== '') {
                    params.set(key, value);
                }
            });
            const queryString = params.toString();
            return queryString ? `${url}?${queryString}` : url;
        }

        function parseJsonResponse(text) {
            if (!text) return {};
            try {
                return JSON.parse(text);
            } catch {
                throw new Error('æ¥å£è¿”å›äº†é JSON æ•°æ®');
            }
        }

        function normalizeApiData(payload) {
            if (!payload || typeof payload !== 'object') return {};
            return payload.data || payload.result || payload;
        }

        function toTimestamp(value) {
            if (value === null || value === undefined || value === '') return null;
            const numeric = Number(value);
            if (Number.isFinite(numeric) && numeric > 100000000000) {
                return numeric;
            }
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? null : parsed.getTime();
        }

        function clampPercent(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return 0;
            return Math.max(0, Math.min(100, num));
        }

        function safeNumber(value, fallback = 0) {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        }

        function buildBearerCandidates(apiKey, extraHeaders = {}) {
            const normalized = String(apiKey || '').trim();
            if (!normalized) return [];
            if (normalized.startsWith('Bearer ')) {
                return [{ ...extraHeaders, Authorization: normalized }];
            }
            return [
                { ...extraHeaders, Authorization: `Bearer ${normalized}` },
                { ...extraHeaders, Authorization: normalized }
            ];
        }

        async function requestJson(url, options = {}) {
            const proxyUrl = getCorsProxyUrl(url);
            const response = await fetch(proxyUrl, {
                method: options.method || 'GET',
                cache: 'no-store',
                headers: {
                    'Accept': 'application/json',
                    'Accept-Language': 'en-US,en',
                    ...options.headers
                },
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            const responseText = await response.text();
            if (!response.ok) {
                let detail = '';
                try {
                    const errorJson = JSON.parse(responseText);
                    detail = errorJson.msg || errorJson.message || errorJson.error || '';
                } catch {
                    detail = responseText.replace(/\s+/g, ' ').trim().slice(0, 180);
                }
                throw new Error(`HTTP ${response.status}${detail ? `: ${detail}` : ''}`);
            }

            return parseJsonResponse(responseText);
        }

        async function requestWithHeaderFallback(url, headerCandidates, options = {}) {
            let lastError = null;
            for (const headers of headerCandidates) {
                try {
                    return await requestJson(url, { ...options, headers });
                } catch (error) {
                    lastError = error;
                    if (!/HTTP 401|HTTP 403/.test(error.message)) {
                        throw error;
                    }
                }
            }
            throw lastError || new Error('è¯·æ±‚å¤±è´¥');
        }

        function getLast24HourUnixWindow() {
            const end = Math.floor(Date.now() / 1000);
            const start = end - 24 * 60 * 60;
            return { start, end };
        }

        function formatTrendLabelFromUnix(unixSeconds) {
            const ts = safeNumber(unixSeconds, 0) * 1000;
            if (!ts) return '--';
            const d = new Date(ts);
            if (Number.isNaN(d.getTime())) return '--';
            return d.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function formatIsoByUnix(unixSeconds) {
            const d = new Date(safeNumber(unixSeconds, 0) * 1000);
            return Number.isNaN(d.getTime()) ? '' : d.toISOString();
        }

        function extractArray(payload) {
            if (Array.isArray(payload)) return payload;
            if (Array.isArray(payload?.data)) return payload.data;
            return [];
        }

        function buildDefaultMcpUsage(sharedUsed = 0, sharedTotal = 0, toolMap = {}) {
            const percent = sharedTotal > 0 ? clampPercent((sharedUsed / sharedTotal) * 100) : 0;
            const result = {
                shared: {
                    used: safeNumber(sharedUsed),
                    total: safeNumber(sharedTotal),
                    percent,
                    reset: null
                }
            };

            getActiveMcpTools().forEach(tool => {
                result[tool.id] = {
                    used: safeNumber(toolMap[tool.id], 0),
                    total: safeNumber(sharedTotal)
                };
            });

            return result;
        }

        function buildUnavailableQuota(platformName, note = 'å¹³å°æœªå…¬å¼€è¯¥ç±»é¢åº¦æ¥å£') {
            return {
                plan: {
                    type: 'metered',
                    expiry: null,
                    cycleUsed: 0,
                    cycleTotal: 0,
                    cyclePercent: 0,
                    cycleReset: null,
                    unavailable: true,
                    note: `${platformName}: ${note}`
                },
                weekly: {
                    used: 0,
                    total: 0,
                    percent: 0,
                    reset: null,
                    estimated: true,
                    unavailable: true,
                    note
                }
            };
        }

        async function fetchGlmData(apiKey) {
            const platform = getPlatformConfig('glm');
            const queryWindow = getLast24HourWindow();
            const requestNonce = Date.now();
            let lastError = null;

            for (const baseUrl of platform.baseUrls) {
                try {
                    const modelUsageUrl = buildUrlWithQuery(baseUrl, platform.apiEndpoints.modelUsage, {
                        ...queryWindow,
                        _ts: requestNonce
                    });
                    const toolUsageUrl = buildUrlWithQuery(baseUrl, platform.apiEndpoints.toolUsage, {
                        ...queryWindow,
                        _ts: requestNonce
                    });
                    const quotaLimitUrl = buildUrlWithQuery(baseUrl, platform.apiEndpoints.quotaLimit, {
                        _ts: requestNonce
                    });

                    const authCandidates = buildBearerCandidates(apiKey, { 'Content-Type': 'application/json' });
                    const [modelUsage, toolUsage, quotaLimit] = await Promise.all([
                        requestWithHeaderFallback(modelUsageUrl, authCandidates),
                        requestWithHeaderFallback(toolUsageUrl, authCandidates),
                        requestWithHeaderFallback(quotaLimitUrl, authCandidates)
                    ]);

                    return {
                        platform: 'glm',
                        baseUrl,
                        queryWindow,
                        modelUsage,
                        toolUsage,
                        quotaLimit
                    };
                } catch (error) {
                    lastError = error;
                    console.warn(`Failed on ${baseUrl}:`, error.message);
                }
            }

            throw lastError || new Error('GLM æ‰€æœ‰å¯ç”¨ API åŸŸåå‡è¯·æ±‚å¤±è´¥');
        }

        async function fetchOpenAiData(apiKey) {
            const platform = getPlatformConfig('openai');
            const window24h = getLast24HourUnixWindow();
            const usageUrl = buildUrlWithQuery(platform.baseUrl, '/organization/usage/completions', {
                start_time: window24h.start,
                end_time: window24h.end,
                bucket_width: '1h',
                limit: 24
            });
            const costUrl = buildUrlWithQuery(platform.baseUrl, '/organization/costs', {
                start_time: window24h.start,
                end_time: window24h.end,
                bucket_width: '1d',
                limit: 1
            });

            const authCandidates = buildBearerCandidates(apiKey, { 'Content-Type': 'application/json' });
            const [usage, cost] = await Promise.all([
                requestWithHeaderFallback(usageUrl, authCandidates),
                requestWithHeaderFallback(costUrl, authCandidates)
            ]);

            return {
                platform: 'openai',
                baseUrl: platform.baseUrl,
                queryWindow: window24h,
                usage,
                cost
            };
        }

        async function fetchAnthropicData(apiKey) {
            const platform = getPlatformConfig('anthropic');
            const window24h = getLast24HourUnixWindow();
            const startIso = formatIsoByUnix(window24h.start);
            const endIso = formatIsoByUnix(window24h.end);

            const usageUrl = buildUrlWithQuery(platform.baseUrl, '/organizations/usage_report/messages', {
                starting_at: startIso,
                ending_at: endIso,
                bucket_width: '1h',
                limit: 24
            });
            const costUrl = buildUrlWithQuery(platform.baseUrl, '/organizations/cost_report', {
                starting_at: startIso,
                ending_at: endIso,
                bucket_width: '1d',
                limit: 1
            });

            const key = String(apiKey || '').trim();
            const headers = {
                'x-api-key': key.startsWith('Bearer ') ? key.slice(7) : key,
                'anthropic-version': '2023-06-01',
                'anthropic-beta': 'usage-cost-api-2025-08-18',
                'Content-Type': 'application/json'
            };
            const [usage, cost] = await Promise.all([
                requestJson(usageUrl, { headers }),
                requestJson(costUrl, { headers })
            ]);

            return {
                platform: 'anthropic',
                baseUrl: platform.baseUrl,
                queryWindow: window24h,
                usage,
                cost
            };
        }

        async function fetchDeepSeekData(apiKey) {
            const platform = getPlatformConfig('deepseek');
            const balanceUrl = buildUrlWithQuery(platform.baseUrl, '/user/balance', {
                _ts: Date.now()
            });
            const authCandidates = buildBearerCandidates(apiKey, { 'Content-Type': 'application/json' });
            const balance = await requestWithHeaderFallback(balanceUrl, authCandidates);

            return {
                platform: 'deepseek',
                baseUrl: platform.baseUrl,
                queryWindow: getLast24HourUnixWindow(),
                balance
            };
        }

        async function fetchStepFunData(apiKey) {
            const platform = getPlatformConfig('stepfun');
            const accountUrl = buildUrlWithQuery(platform.baseUrl, '/accounts', { _ts: Date.now() });
            const modelsUrl = buildUrlWithQuery(platform.baseUrl, '/models', { _ts: Date.now() });
            const authCandidates = buildBearerCandidates(apiKey, { 'Content-Type': 'application/json' });

            const account = await requestWithHeaderFallback(accountUrl, authCandidates);
            let models = { data: [] };
            try {
                models = await requestWithHeaderFallback(modelsUrl, authCandidates);
            } catch (error) {
                console.warn('StepFun models endpoint unavailable:', error.message);
            }

            return {
                platform: 'stepfun',
                baseUrl: platform.baseUrl,
                queryWindow: getLast24HourUnixWindow(),
                account,
                models
            };
        }

        async function fetchAllData(apiKey) {
            showLoading(true);
            hideError();

            switch (state.platformId) {
                case 'glm':
                    return fetchGlmData(apiKey);
                case 'openai':
                    return fetchOpenAiData(apiKey);
                case 'anthropic':
                    return fetchAnthropicData(apiKey);
                case 'deepseek':
                    return fetchDeepSeekData(apiKey);
                case 'stepfun':
                    return fetchStepFunData(apiKey);
                default:
                    throw new Error(`æš‚ä¸æ”¯æŒçš„å¹³å°: ${state.platformId}`);
            }
        }

        async function refreshData() {
            if (state.apiKeys.length === 0) {
                showError(`è¯·å…ˆè¾“å…¥ ${getPlatformConfig().name} API Key`);
                return;
            }

            const targetIndex = state.currentKeyIndex;
            const apiKey = state.apiKeys[targetIndex];
            const activeRequestId = ++state.requestId;
            const platform = getPlatformConfig();

            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            btn.disabled = true;
            icon.classList.add('loading-spinner');
            updateKeyStatus(`æ­£åœ¨æŸ¥è¯¢ ${platform.name} è´¦æˆ· ${targetIndex + 1}ï¼ˆ${maskApiKey(apiKey)}ï¼‰...`);

            try {
                const data = await fetchAllData(apiKey);
                if (activeRequestId !== state.requestId || targetIndex !== state.currentKeyIndex) {
                    return;
                }

                const parsedData = parseApiData(data);
                parsedData.account = {
                    index: targetIndex,
                    keyMask: maskApiKey(apiKey)
                };
                state.data = parsedData;
                state.accountData[targetIndex] = parsedData;
                upsertKeyTracking(apiKey, parsedData);
                updateUI();
                saveHistoryData(state.data);

                document.getElementById('dashboardContent').classList.remove('hidden');
                hideError();
                updateKeyStatus(`å½“å‰æŸ¥çœ‹: ${platform.name} è´¦æˆ· ${targetIndex + 1}ï¼ˆ${maskApiKey(apiKey)}ï¼‰`);
            } catch (error) {
                if (activeRequestId !== state.requestId) {
                    return;
                }
                console.error('Fetch error:', error);
                const hint = /HTTP 403|Failed to fetch|NetworkError/i.test(error.message)
                    ? 'ã€‚å¯å°è¯•åœ¨â€œè®¾ç½®â€ä¸­åˆ‡æ¢ CORS ä»£ç†ï¼Œæˆ–ç”¨ Live Server å¹¶é€‰æ‹©â€œä¸ä½¿ç”¨ä»£ç†â€ã€‚'
                    : '';
                showError(`è·å– ${platform.name} æ•°æ®å¤±è´¥: ${error.message}${hint}`);
            } finally {
                if (activeRequestId === state.requestId) {
                    btn.disabled = false;
                    icon.classList.remove('loading-spinner');
                    showLoading(false);
                    updateLastRefresh();
                }
            }
        }

        function parseApiData(rawData, platformId = state.platformId) {
            switch (platformId) {
                case 'glm':
                    return parseGlmApiData(rawData);
                case 'openai':
                    return parseOpenAiData(rawData);
                case 'anthropic':
                    return parseAnthropicData(rawData);
                case 'deepseek':
                    return parseDeepSeekData(rawData);
                case 'stepfun':
                    return parseStepFunData(rawData);
                default:
                    throw new Error(`æ²¡æœ‰å¯ç”¨çš„è§£æå™¨: ${platformId}`);
            }
        }

        function parseGlmApiData(rawData) {
            const modelUsage = normalizeApiData(rawData.modelUsage);
            const toolUsage = normalizeApiData(rawData.toolUsage);
            const quotaLimit = normalizeApiData(rawData.quotaLimit);

            const planLevel = String(quotaLimit.level || 'pro').toLowerCase();
            const planType = CONFIG.planLimits[planLevel] ? planLevel : 'pro';
            const planLimits = CONFIG.planLimits[planType] || CONFIG.planLimits.pro;
            const limitItems = Array.isArray(quotaLimit.limits) ? quotaLimit.limits : [];

            const tokenLimits = limitItems.filter(item =>
                String(item.type || '').toUpperCase().includes('TOKEN')
            );

            const cycleLimit = tokenLimits.find(item =>
                Number(item.unit) === 3 && Number(item.number) === 5
            ) || tokenLimits[0] || null;

            const weeklyLimit = tokenLimits.find(item =>
                Number(item.unit) === 6 && Number(item.number) === 1
            ) || tokenLimits[1] || null;

            const cyclePercent = clampPercent(cycleLimit?.percentage);
            const weeklyPercent = clampPercent(weeklyLimit?.percentage);
            const cycleTotal = planLimits.cycleMax;
            const weeklyTotal = planLimits.weeklyMax;
            const cycleUsed = Math.round((cycleTotal * cyclePercent) / 100);
            const weeklyUsed = Math.round((weeklyTotal * weeklyPercent) / 100);

            const timeLimit = limitItems.find(item =>
                String(item.type || '').toUpperCase().includes('TIME_LIMIT')
            ) || null;

            const toolTotals = toolUsage.totalUsage || {};
            const usageDetails = Array.isArray(timeLimit?.usageDetails) ? timeLimit.usageDetails : [];
            const detailMap = usageDetails.reduce((acc, item) => {
                if (item && item.modelCode) {
                    acc[item.modelCode] = Number(item.usage || 0);
                }
                return acc;
            }, {});

            const mcpSharedTotal = Number(timeLimit?.usage || 0);
            const mcpSharedUsed = Number(
                timeLimit?.currentValue ?? toolTotals.totalSearchMcpCount ?? 0
            );

            const mcpUsage = {
                shared: {
                    used: mcpSharedUsed,
                    total: mcpSharedTotal,
                    percent: clampPercent(timeLimit?.percentage),
                    reset: toTimestamp(timeLimit?.nextResetTime)
                },
                web_search: {
                    used: detailMap['search-prime'] ?? Number(toolTotals.totalNetworkSearchCount || 0),
                    total: mcpSharedTotal
                },
                web_reader: {
                    used: detailMap['web-reader'] ?? Number(toolTotals.totalWebReadMcpCount || 0),
                    total: mcpSharedTotal
                },
                vision: {
                    used: detailMap['zread'] ?? Number(toolTotals.totalZreadMcpCount || 0),
                    total: mcpSharedTotal
                }
            };

            const modelBalances = {};
            if (Array.isArray(modelUsage.modelDetails)) {
                modelUsage.modelDetails.forEach(item => {
                    const modelId = item.model || item.modelCode || item.name;
                    if (!modelId) return;
                    const used = Number(item.used || item.usedTokens || item.usedCount || 0);
                    const total = Number(item.total || item.totalTokens || item.quota || 0);
                    modelBalances[modelId] = {
                        used,
                        total,
                        remaining: Number(item.remaining || Math.max(total - used, 0))
                    };
                });
            }

            const trendLabels = Array.isArray(modelUsage.x_time) ? modelUsage.x_time : [];
            const trendTokens = Array.isArray(modelUsage.tokensUsage)
                ? modelUsage.tokensUsage.map(v => Number(v || 0))
                : [];
            const trendCalls = Array.isArray(modelUsage.modelCallCount)
                ? modelUsage.modelCallCount.map(v => Number(v || 0))
                : [];
            const totalCalls24h = Number(modelUsage.totalUsage?.totalModelCallCount || 0);
            const totalTokens24h = Number(modelUsage.totalUsage?.totalTokensUsage || 0);

            return {
                user: {
                    tokens24h: totalTokens24h,
                    calls24h: totalCalls24h,
                    cyclePercent,
                    source: rawData.baseUrl || '--'
                },
                plan: {
                    type: planType,
                    expiry: null,
                    cycleUsed,
                    cycleTotal,
                    cyclePercent,
                    cycleReset: toTimestamp(cycleLimit?.nextResetTime)
                },
                weekly: {
                    used: weeklyUsed,
                    total: weeklyTotal,
                    percent: weeklyPercent,
                    reset: toTimestamp(weeklyLimit?.nextResetTime),
                    estimated: !weeklyLimit
                },
                modelBalances,
                modelSummary: {
                    totalCalls24h,
                    totalTokens24h,
                    latestCalls: trendCalls.length ? trendCalls[trendCalls.length - 1] : 0,
                    latestTokens: trendTokens.length ? trendTokens[trendTokens.length - 1] : 0
                },
                mcpUsage,
                trend: {
                    labels: trendLabels,
                    tokens: trendTokens,
                    calls: trendCalls
                },
                meta: {
                    platform: 'glm',
                    supports: getPlatformConfig('glm').supports
                }
            };
        }

        function parseOpenAiData(rawData) {
            const usageBuckets = extractArray(rawData.usage);
            const costBuckets = extractArray(rawData.cost);
            const modelUsedMap = {};
            const trendLabels = [];
            const trendTokens = [];
            const trendCalls = [];
            let totalTokens24h = 0;
            let totalCalls24h = 0;

            usageBuckets
                .slice()
                .sort((a, b) => safeNumber(a?.start_time) - safeNumber(b?.start_time))
                .forEach(bucket => {
                    const results = Array.isArray(bucket?.results) ? bucket.results : [];
                    let bucketTokens = 0;
                    let bucketCalls = 0;
                    results.forEach(item => {
                        const tokenCount =
                            safeNumber(item?.input_tokens) +
                            safeNumber(item?.output_tokens) +
                            safeNumber(item?.input_cached_tokens) +
                            safeNumber(item?.input_audio_tokens) +
                            safeNumber(item?.output_audio_tokens);
                        const callCount = safeNumber(item?.num_model_requests);
                        const modelName = item?.model || 'all-models';
                        modelUsedMap[modelName] = safeNumber(modelUsedMap[modelName]) + tokenCount;
                        bucketTokens += tokenCount;
                        bucketCalls += callCount;
                    });

                    trendLabels.push(formatTrendLabelFromUnix(bucket?.start_time));
                    trendTokens.push(bucketTokens);
                    trendCalls.push(bucketCalls);
                    totalTokens24h += bucketTokens;
                    totalCalls24h += bucketCalls;
                });

            const costResult = costBuckets[0]?.results || [];
            const totalCost = costResult.reduce((sum, item) => {
                return sum + safeNumber(item?.amount?.value);
            }, 0);
            const currency = costResult[0]?.amount?.currency || 'USD';
            const modelBalances = Object.entries(modelUsedMap).reduce((acc, [model, used]) => {
                acc[model] = { used, total: 0, remaining: 0, usageOnly: true };
                return acc;
            }, {});

            const unavailable = buildUnavailableQuota('OpenAI');
            return {
                user: {
                    tokens24h: totalTokens24h,
                    calls24h: totalCalls24h,
                    cyclePercent: 0,
                    source: rawData.baseUrl || '--'
                },
                plan: unavailable.plan,
                weekly: unavailable.weekly,
                modelBalances,
                modelSummary: {
                    totalCalls24h,
                    totalTokens24h,
                    latestCalls: trendCalls.length ? trendCalls[trendCalls.length - 1] : 0,
                    latestTokens: trendTokens.length ? trendTokens[trendTokens.length - 1] : 0
                },
                mcpUsage: buildDefaultMcpUsage(0, 0),
                trend: {
                    labels: trendLabels,
                    tokens: trendTokens,
                    calls: trendCalls
                },
                meta: {
                    platform: 'openai',
                    cost24h: totalCost,
                    currency,
                    supports: getPlatformConfig('openai').supports,
                    notes: ['éœ€ç»„ç»‡ç®¡ç†å‘˜ API Key æ‰èƒ½è®¿é—® Organization Usage/Cost æ¥å£']
                }
            };
        }

        function parseAnthropicData(rawData) {
            const usageBuckets = extractArray(rawData.usage);
            const costBuckets = extractArray(rawData.cost);
            const modelUsedMap = {};
            const trendLabels = [];
            const trendTokens = [];
            const trendCalls = [];
            let totalTokens24h = 0;
            let webSearchCount = 0;
            let codeExecCount = 0;
            let webFetchCount = 0;

            usageBuckets
                .slice()
                .sort((a, b) => safeNumber(toTimestamp(a?.starting_at)) - safeNumber(toTimestamp(b?.starting_at)))
                .forEach(bucket => {
                    const results = Array.isArray(bucket?.results) ? bucket.results : [];
                    let bucketTokens = 0;
                    results.forEach(item => {
                        const tokenCount =
                            safeNumber(item?.uncached_input_tokens) +
                            safeNumber(item?.cache_read_input_tokens) +
                            safeNumber(item?.cache_creation_input_tokens) +
                            safeNumber(item?.output_tokens);
                        const modelName = item?.model || 'claude-all';
                        modelUsedMap[modelName] = safeNumber(modelUsedMap[modelName]) + tokenCount;
                        bucketTokens += tokenCount;

                        const toolUse = item?.server_tool_use || {};
                        webSearchCount += safeNumber(toolUse.web_search_requests);
                        codeExecCount += safeNumber(toolUse.code_execution_tool_result_blocks);
                        webFetchCount += safeNumber(toolUse.web_fetch_tool_result_blocks);
                    });

                    trendLabels.push(new Date(bucket?.starting_at || Date.now()).toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }));
                    trendTokens.push(bucketTokens);
                    trendCalls.push(0);
                    totalTokens24h += bucketTokens;
                });

            const costResult = costBuckets[0]?.results || [];
            const totalCostMinor = costResult.reduce((sum, item) => {
                return sum + safeNumber(item?.amount);
            }, 0);
            const currency = costResult[0]?.currency || 'usd';
            const totalCostApprox = totalCostMinor / 100;

            const modelBalances = Object.entries(modelUsedMap).reduce((acc, [model, used]) => {
                acc[model] = { used, total: 0, remaining: 0, usageOnly: true };
                return acc;
            }, {});

            const sharedMcpUsed = webSearchCount + codeExecCount + webFetchCount;
            const unavailable = buildUnavailableQuota('Anthropic');
            return {
                user: {
                    tokens24h: totalTokens24h,
                    calls24h: 0,
                    cyclePercent: 0,
                    source: rawData.baseUrl || '--'
                },
                plan: unavailable.plan,
                weekly: unavailable.weekly,
                modelBalances,
                modelSummary: {
                    totalCalls24h: 0,
                    totalTokens24h,
                    latestCalls: 0,
                    latestTokens: trendTokens.length ? trendTokens[trendTokens.length - 1] : 0
                },
                mcpUsage: buildDefaultMcpUsage(sharedMcpUsed, 0, {
                    web_search: webSearchCount,
                    code_execution: codeExecCount,
                    web_fetch: webFetchCount
                }),
                trend: {
                    labels: trendLabels,
                    tokens: trendTokens,
                    calls: trendCalls
                },
                meta: {
                    platform: 'anthropic',
                    cost24h: totalCostApprox,
                    currency,
                    supports: getPlatformConfig('anthropic').supports,
                    notes: ['Anthropic cost_report è¿”å›é‡‘é¢ä¸ºæœ€å°è´§å¸å•ä½ï¼ˆminor unitsï¼‰ï¼Œæ­¤å¤„å·²æŒ‰ /100 è¿‘ä¼¼æ¢ç®—']
                }
            };
        }

        function parseDeepSeekData(rawData) {
            const balance = normalizeApiData(rawData.balance);
            const infos = Array.isArray(balance?.balance_infos) ? balance.balance_infos : [];
            const totalBalance = infos.reduce((sum, item) => sum + safeNumber(item?.total_balance), 0);
            const grantedBalance = infos.reduce((sum, item) => sum + safeNumber(item?.granted_balance), 0);
            const toppedUpBalance = infos.reduce((sum, item) => sum + safeNumber(item?.topped_up_balance), 0);
            const currency = infos[0]?.currency || 'CNY';

            const unavailable = buildUnavailableQuota('DeepSeek', 'å½“å‰å®˜æ–¹å…¬å¼€ä½™é¢æ¥å£ï¼Œä¸å«è¯¦ç»†åˆ†æ—¶ç”¨é‡');
            return {
                user: {
                    tokens24h: 0,
                    calls24h: 0,
                    cyclePercent: 0,
                    source: rawData.baseUrl || '--'
                },
                plan: unavailable.plan,
                weekly: unavailable.weekly,
                modelBalances: {
                    balance_total: {
                        used: 0,
                        total: totalBalance,
                        remaining: totalBalance
                    }
                },
                modelSummary: {
                    totalCalls24h: 0,
                    totalTokens24h: 0,
                    latestCalls: 0,
                    latestTokens: 0
                },
                mcpUsage: buildDefaultMcpUsage(0, 0),
                trend: {
                    labels: [],
                    tokens: [],
                    calls: []
                },
                meta: {
                    platform: 'deepseek',
                    currency,
                    balance: {
                        total: totalBalance,
                        granted: grantedBalance,
                        toppedUp: toppedUpBalance
                    },
                    supports: getPlatformConfig('deepseek').supports,
                    notes: ['DeepSeek å½“å‰å…¬å¼€æ¥å£ä»¥ä½™é¢æŸ¥è¯¢ä¸ºä¸»']
                }
            };
        }

        function parseStepFunData(rawData) {
            const account = normalizeApiData(rawData.account);
            const accountInfo = Array.isArray(account?.accounts) ? (account.accounts[0] || {}) : account;
            const modelsPayload = normalizeApiData(rawData.models);
            const modelItems = Array.isArray(modelsPayload?.data)
                ? modelsPayload.data
                : (Array.isArray(modelsPayload) ? modelsPayload : []);

            const totalBalance = safeNumber(
                accountInfo?.balance ??
                account?.balance ??
                accountInfo?.available_balance ??
                account?.available_balance,
                0
            );
            const currency = accountInfo?.currency || account?.currency || 'CNY';
            const unavailable = buildUnavailableQuota('StepFun', 'å½“å‰å…¬å¼€æ¥å£ä»¥è´¦æˆ·ä½™é¢ä¸ºä¸»ï¼Œåˆ†æ—¶ç”¨é‡/è´¦å•æœªå¼€æ”¾');

            return {
                user: {
                    tokens24h: 0,
                    calls24h: 0,
                    cyclePercent: 0,
                    source: rawData.baseUrl || '--'
                },
                plan: unavailable.plan,
                weekly: unavailable.weekly,
                modelBalances: {
                    balance_total: {
                        used: 0,
                        total: totalBalance,
                        remaining: totalBalance
                    }
                },
                modelSummary: {
                    totalCalls24h: 0,
                    totalTokens24h: 0,
                    latestCalls: 0,
                    latestTokens: 0
                },
                mcpUsage: buildDefaultMcpUsage(0, 0),
                trend: {
                    labels: [],
                    tokens: [],
                    calls: []
                },
                meta: {
                    platform: 'stepfun',
                    currency,
                    balance: {
                        total: totalBalance
                    },
                    modelCount: modelItems.length,
                    supports: getPlatformConfig('stepfun').supports,
                    notes: ['StepFun å·²æ¥å…¥ /v1/accountsï¼›å½“å‰å…¬å¼€æ¥å£æœªæä¾›ç»Ÿä¸€åˆ†æ—¶ç”¨é‡è´¦å•']
                }
            };
        }

        // ==================== UI Updates ====================
        function updateUI() {
            const data = state.data;
            if (!data) return;

            // Update account selector
            if (state.apiKeys.length > 1) {
                updateAccountSelector();
            } else {
                document.getElementById('accountSelector').classList.add('hidden');
            }

            // Update plan info
            updatePlatformMetaCard(data);
            updatePlanInfo(data.plan);

            // Update cycle info
            updateCycleInfo(data.plan);

            // Update weekly quota
            updateWeeklyInfo(data.weekly);

            // Update account status
            updateAccountStatus(data.user);

            // Update model balances
            updateModelBalances(data.modelBalances);

            // Update MCP tools
            updateMcpTools(data.mcpUsage);

            // Update detailed table
            updateDetailedTable(data);

            // Update chart
            updateChart(data);
            updateVisualCharts(data);
        }

        function updatePlatformMetaCard(data) {
            const card = document.getElementById('platformMetaCard');
            const body = document.getElementById('platformMetaBody');
            if (!card || !body || !data) return;

            const meta = data.meta || {};
            const platform = getPlatformConfig();
            const supports = meta.supports || platform.supports || {};
            const costValue = safeNumber(meta.cost24h);
            const costText = costValue > 0
                ? `${costValue.toFixed(4)} ${String(meta.currency || '').toUpperCase()}`
                : '--';
            const notes = Array.isArray(meta.notes) ? meta.notes : [];

            const supportEntries = [
                `å‘¨æœŸé¢åº¦: ${supports.cycleQuota ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ / æœªå…¬å¼€'}`,
                `æ¯å‘¨é¢åº¦: ${supports.weeklyQuota ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ / æœªå…¬å¼€'}`,
                `å·¥å…·ç»´åº¦: ${supports.mcp ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ / æœªå…¬å¼€'}`
            ];

            body.innerHTML = `
                <div class="p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                    <div class="font-medium mb-1">å½“å‰å¹³å°</div>
                    <div style="color: var(--text-secondary)">${platform.name}</div>
                </div>
                <div class="p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                    <div class="font-medium mb-1">æ•°æ®æº</div>
                    <div style="color: var(--text-secondary)">${data.user?.source || '--'}</div>
                </div>
                <div class="p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                    <div class="font-medium mb-1">24h æˆæœ¬</div>
                    <div style="color: var(--text-secondary)">${costText}</div>
                </div>
                <div class="p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                    <div class="font-medium mb-1">æ¥å£è¦†ç›–</div>
                    <div style="color: var(--text-secondary)">${supportEntries.join(' Â· ')}</div>
                </div>
                ${notes.length > 0 ? `
                <div class="md:col-span-2 p-3 rounded-lg text-xs" style="background-color: var(--bg-tertiary); color: var(--text-secondary)">
                    è¯´æ˜: ${notes.join('ï¼›')}
                </div>
                ` : ''}
            `;
            card.classList.remove('hidden');
        }

        function updateAccountSelector() {
            const container = document.getElementById('accountSelector');
            const tabs = document.getElementById('accountTabs');
            const hint = document.getElementById('accountTrackingHint');
            const currentKey = state.apiKeys[state.currentKeyIndex];
            const tracking = getKeyTracking(currentKey);
            const platformName = getPlatformConfig().name;

            container.classList.remove('hidden');
            tabs.innerHTML = state.apiKeys.map((key, index) => `
                <button
                    class="${index === state.currentKeyIndex ? 'account-tab account-tab-active' : 'account-tab btn-secondary'}"
                    onclick="switchAccount(${index})"
                >
                    è´¦æˆ· ${index + 1} Â· ${maskApiKey(key)}${state.keyTracking[key]?.delta?.tokens ? ` Â· Î”${formatNumber(state.keyTracking[key].delta.tokens)}` : ''}
                </button>
            `).join('');

            if (tracking?.delta) {
                hint.textContent = `æœ¬åœ°è¿½è¸ªï¼ˆä¼°ç®—ï¼‰: Î”Tokens ${formatNumber(tracking.delta.tokens)} Â· Î”è°ƒç”¨ ${formatNumber(tracking.delta.calls)} Â· Î”MCP ${formatNumber(tracking.delta.mcp)}ã€‚${platformName} è‹¥æŒ‰ä¸»è´¦å·æ±‡æ€»ï¼Œåˆ‡æ¢ Key å¯èƒ½æ˜¾ç¤ºåŒä¸€å®˜æ–¹æ€»é‡ã€‚`;
            } else {
                hint.textContent = `æœ¬åœ°è¿½è¸ªï¼ˆä¼°ç®—ï¼‰: é¦–æ¬¡åŠ è½½åå°†è®°å½•è¯¥ Key å¢é‡ã€‚${platformName} å¦‚æŒ‰ä¸»è´¦å·ç»“ç®—ï¼Œå¤š Key å®˜æ–¹æ€»é‡å¯èƒ½ä¸€è‡´ã€‚`;
            }
        }

        function resetCurrentAccountTracking() {
            if (state.apiKeys.length === 0) return;
            const key = state.apiKeys[state.currentKeyIndex];
            if (!state.data) {
                showError('è¯·å…ˆæŸ¥è¯¢ä¸€æ¬¡å½“å‰è´¦æˆ·ï¼Œå†é‡ç½®è¿½è¸ªåŸºçº¿ã€‚');
                return;
            }

            const snapshot = buildTrackingSnapshot(state.data);
            state.keyTracking[key] = {
                baseline: snapshot,
                latest: snapshot,
                delta: { tokens: 0, calls: 0, mcp: 0, cycle: 0, weekly: 0 },
                updatedAt: Date.now()
            };
            saveKeyTracking();
            updateUI();
            updateKeyStatus(`å·²é‡ç½® ${getPlatformConfig().name} è´¦æˆ· ${state.currentKeyIndex + 1}ï¼ˆ${maskApiKey(key)}ï¼‰è¿½è¸ªåŸºçº¿`);
        }

        function switchAccount(index) {
            state.currentKeyIndex = index;
            const cachedData = state.accountData[index];
            if (cachedData) {
                state.data = cachedData;
                updateUI();
                updateKeyStatus(`å½“å‰æŸ¥çœ‹: ${getPlatformConfig().name} è´¦æˆ· ${index + 1}ï¼ˆ${maskApiKey(state.apiKeys[index])}ï¼‰`);
            }
            refreshData();
        }

        function updatePlanInfo(plan) {
            const badge = document.getElementById('planBadge');
            const expiry = document.getElementById('planExpiry');
            const availableTypes = ['lite', 'pro', 'max', 'metered'];
            const planType = availableTypes.includes(plan.type) ? plan.type : 'pro';

            badge.className = `badge badge-${planType}`;
            badge.textContent = planType === 'metered' ? 'METERED' : planType.toUpperCase();

            if (plan.unavailable) {
                expiry.textContent = plan.note || 'è¯¥å¹³å°æœªå…¬å¼€å¥—é¤å‘¨æœŸé¢åº¦';
            } else if (plan.expiry) {
                const expiryDate = new Date(plan.expiry);
                expiry.textContent = `æœ‰æ•ˆæœŸè‡³ ${formatDate(expiryDate)}`;
            } else {
                expiry.textContent = '';
            }
        }

        function updateCycleInfo(plan) {
            if (plan.unavailable) {
                document.getElementById('cycleUsed').textContent = '--';
                document.getElementById('cycleTotal').textContent = '--';
                const progress = document.getElementById('cycleProgress');
                progress.style.width = '0%';
                progress.style.backgroundColor = 'var(--border-color)';
                document.getElementById('cycleReset').textContent = plan.note || 'å¹³å°æœªæä¾›';
                return;
            }

            document.getElementById('cycleUsed').textContent = plan.cycleUsed;
            document.getElementById('cycleTotal').textContent = plan.cycleTotal;

            const percent = plan.cycleTotal > 0 ? (plan.cycleUsed / plan.cycleTotal) * 100 : 0;
            const progress = document.getElementById('cycleProgress');
            progress.style.width = `${percent}%`;
            progress.style.backgroundColor = 'var(--success-color)';

            if (percent > 80) {
                progress.style.backgroundColor = 'var(--danger-color)';
            } else if (percent > 50) {
                progress.style.backgroundColor = 'var(--warning-color)';
            }

            if (plan.cycleReset) {
                document.getElementById('cycleReset').textContent = formatTime(new Date(plan.cycleReset));
            } else {
                document.getElementById('cycleReset').textContent = '--';
            }
        }

        function updateWeeklyInfo(weekly) {
            if (weekly.unavailable) {
                document.getElementById('weeklyPercent').textContent = '--';
                const progress = document.getElementById('weeklyProgress');
                progress.style.width = '0%';
                progress.style.backgroundColor = 'var(--border-color)';
                document.getElementById('weeklyReset').textContent = weekly.note || 'å¹³å°æœªæä¾›';
                return;
            }

            document.getElementById('weeklyPercent').textContent = `${weekly.percent}%`;

            const progress = document.getElementById('weeklyProgress');
            progress.style.width = `${weekly.percent}%`;
            progress.style.backgroundColor = 'var(--warning-color)';

            if (weekly.percent > 80) {
                progress.style.backgroundColor = 'var(--danger-color)';
            } else if (weekly.percent > 50) {
                progress.style.backgroundColor = 'var(--warning-color)';
            } else {
                progress.style.backgroundColor = 'var(--success-color)';
            }

            if (weekly.reset) {
                document.getElementById('weeklyReset').textContent = formatDate(new Date(weekly.reset));
            } else if (weekly.estimated) {
                document.getElementById('weeklyReset').textContent = 'æ¥å£æœªè¿”å›';
            } else {
                document.getElementById('weeklyReset').textContent = '--';
            }
        }

        function updateAccountStatus(user) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const balance = document.getElementById('accountBalance');
            const calls = document.getElementById('accountCalls');
            const meta = state.data?.meta || {};
            if (meta?.balance && Number.isFinite(Number(meta.balance.total))) {
                balance.textContent = `${Number(meta.balance.total).toFixed(2)} ${meta.currency || ''}`;
                calls.textContent = 'ä½™é¢æ¥å£';
            } else {
                balance.textContent = `${formatNumber(user.tokens24h || 0)} tokens`;
                calls.textContent = `${formatNumber(user.calls24h || 0)}`;
            }

            if (state.data?.plan?.unavailable) {
                statusDot.className = 'status-dot status-success';
                statusText.textContent = 'å¹³å°æœªæä¾›å‘¨æœŸé¢åº¦ï¼Œå·²å±•ç¤ºå¯æŸ¥è¯¢æŒ‡æ ‡';
                return;
            }

            if ((user.cyclePercent || 0) >= 90) {
                statusDot.className = 'status-dot status-danger';
                statusText.textContent = '5å°æ—¶é¢åº¦æ¥è¿‘ä¸Šé™';
            } else if ((user.cyclePercent || 0) >= 70) {
                statusDot.className = 'status-dot status-warning';
                statusText.textContent = '5å°æ—¶é¢åº¦æ¶ˆè€—è¾ƒå¿«';
            } else {
                statusDot.className = 'status-dot status-success';
                statusText.textContent = 'æ­£å¸¸';
            }
        }

        function updateModelBalances(balances) {
            const container = document.getElementById('modelBalances');
            const entries = Object.entries(balances || {});

            if (entries.length === 0) {
                const summary = state.data?.modelSummary || {};
                container.innerHTML = `
                    <div class="p-3 rounded-lg text-sm" style="background-color: var(--bg-tertiary); color: var(--text-secondary)">
                        å½“å‰å®˜æ–¹æ¥å£ä»…è¿”å›æ¨¡å‹æ€»ç”¨é‡ï¼Œä¸è¿”å›å•æ¨¡å‹ä½™é¢ã€‚
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                            <span class="font-medium">24h æ€»è°ƒç”¨æ¬¡æ•°</span>
                            <span class="font-semibold">${formatNumber(summary.totalCalls24h || 0)}</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                            <span class="font-medium">24h æ€» Token ç”¨é‡</span>
                            <span class="font-semibold">${formatNumber(summary.totalTokens24h || 0)}</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                            <span class="font-medium">æœ€è¿‘ä¸€å°æ—¶ Token</span>
                            <span class="font-semibold">${formatNumber(summary.latestTokens || 0)}</span>
                        </div>
                    </div>
                `;
                return;
            }

            const hasUsageOnly = entries.some(([, value]) => value?.usageOnly || safeNumber(value?.total) <= 0);
            if (hasUsageOnly) {
                const maxUsed = Math.max(...entries.map(([, value]) => safeNumber(value?.used, 0)), 1);
                container.innerHTML = `
                    <div class="p-3 rounded-lg text-sm mb-3" style="background-color: var(--bg-tertiary); color: var(--text-secondary)">
                        å½“å‰å¹³å°è¿”å›çš„æ˜¯æ¨¡å‹ç”¨é‡ç»Ÿè®¡ï¼ˆUsageï¼‰ï¼Œæœªè¿”å›æ¨¡å‹æ€»é¢åº¦ä¸Šé™ï¼ˆQuotaï¼‰ã€‚
                    </div>
                    ${entries.map(([model, data]) => {
                        const modelInfo = getActiveModels().find(m => m.id === model) || { name: model, color: '#6b7280' };
                        const used = safeNumber(data?.used, 0);
                        const ratio = Math.max(6, Math.round((used / maxUsed) * 100));
                        return `
                            <div class="mb-3">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full" style="background-color: ${modelInfo.color}"></div>
                                        <span class="font-medium">${modelInfo.name}</span>
                                    </div>
                                    <span class="text-sm">24h ç”¨é‡: ${formatNumber(used)} tokens</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="background-color: ${modelInfo.color}; width: ${ratio}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
                return;
            }

            container.innerHTML = entries.map(([model, data]) => {
                const modelInfo = getActiveModels().find(m => m.id === model) || { name: model, color: '#6b7280' };
                const remaining = Number.isFinite(Number(data.remaining))
                    ? Number(data.remaining)
                    : (Number(data.total || 0) - Number(data.used || 0));
                const percent = data.total > 0 ? (remaining / data.total) * 100 : 100;

                return `
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${modelInfo.color}"></div>
                                <span class="font-medium">${modelInfo.name}</span>
                            </div>
                            <span class="text-sm">${formatNumber(remaining)} / ${formatNumber(data.total)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="background-color: ${modelInfo.color}; width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMcpTools(mcpUsage) {
            const container = document.getElementById('mcpTools');
            if (state.data?.meta?.supports?.mcp === false) {
                container.innerHTML = `
                    <div class="p-3 rounded-lg text-sm" style="background-color: var(--bg-tertiary); color: var(--text-secondary)">
                        å½“å‰å¹³å°æœªå…¬å¼€ MCP / å·¥å…·è°ƒç”¨ç»´åº¦æ¥å£ã€‚
                    </div>
                `;
                return;
            }

            const shared = mcpUsage?.shared || { used: 0, total: 0, percent: 0, reset: null };
            const sharedRemaining = Math.max((shared.total || 0) - (shared.used || 0), 0);

            const summaryBlock = `
                <div class="p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                    <div class="flex items-center justify-between">
                        <span class="font-medium">MCP å…±äº«é¢åº¦</span>
                        <span class="font-semibold">${formatNumber(shared.used || 0)} / ${formatNumber(shared.total || 0)}</span>
                    </div>
                    <div class="text-xs mt-1" style="color: var(--text-secondary)">
                        å‰©ä½™: ${formatNumber(sharedRemaining)} Â· å·²ç”¨ ${shared.percent || 0}%
                    </div>
                </div>
            `;

            const toolBlocks = getActiveMcpTools().map(tool => {
                const usage = mcpUsage[tool.id] || { used: 0, total: shared.total || 0 };
                const percentBase = Number(shared.total || usage.total || 0);
                const percent = percentBase > 0
                    ? Math.round((Number(usage.used || 0) / percentBase) * 100)
                    : 0;
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary)">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${tool.icon}</span>
                            <span class="font-medium">${tool.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${formatNumber(usage.used || 0)}</div>
                            <div class="text-xs" style="color: var(--text-secondary)">
                                å å…±äº«é¢åº¦ ${percent}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = summaryBlock + toolBlocks;
        }

        function updateDetailedTable(data) {
            const tbody = document.getElementById('usageTableBody');
            const rows = [];

            if (!data.plan?.unavailable) {
                rows.push({
                    name: '5å°æ—¶å‘¨æœŸ',
                    used: data.plan.cycleUsed,
                    total: data.plan.cycleTotal,
                    remaining: data.plan.cycleTotal - data.plan.cycleUsed
                });
            }

            if (!data.weekly?.unavailable) {
                rows.push({
                    name: 'æ¯å‘¨é¢åº¦',
                    used: data.weekly.used,
                    total: data.weekly.total,
                    remaining: data.weekly.total - data.weekly.used
                });
            }

            if (data.meta?.supports?.mcp !== false) {
                rows.push({
                    name: 'MCP å…±äº«é¢åº¦',
                    used: data.mcpUsage?.shared?.used || 0,
                    total: data.mcpUsage?.shared?.total || 0,
                    remaining: Math.max((data.mcpUsage?.shared?.total || 0) - (data.mcpUsage?.shared?.used || 0), 0)
                });
            }

            Object.entries(data.modelBalances).forEach(([model, balance]) => {
                const modelInfo = getActiveModels().find(m => m.id === model) || { name: model };
                const usageOnly = Boolean(balance.usageOnly) || safeNumber(balance.total) <= 0;
                rows.push({
                    name: modelInfo.name,
                    used: balance.used,
                    total: usageOnly ? null : balance.total,
                    remaining: usageOnly ? null : (balance.remaining || balance.total - balance.used),
                    usageOnly
                });
            });

            if (safeNumber(data.meta?.cost24h) > 0) {
                rows.push({
                    name: `24h æˆæœ¬ (${String(data.meta.currency || '').toUpperCase()})`,
                    used: Number(data.meta.cost24h).toFixed(4),
                    total: null,
                    remaining: null,
                    usageOnly: true
                });
            }

            if (rows.length === 0) {
                rows.push({
                    name: '24h Tokens',
                    used: data.modelSummary?.totalTokens24h || 0,
                    total: null,
                    remaining: null,
                    usageOnly: true
                });
            }

            tbody.innerHTML = rows.map(row => {
                if (row.usageOnly) {
                    return `
                        <tr style="border-bottom: 1px solid var(--border-color)">
                            <td class="py-3 px-4">${row.name}</td>
                            <td class="py-3 px-4 text-right">${typeof row.used === 'string' ? row.used : formatNumber(row.used)}</td>
                            <td class="py-3 px-4 text-right">--</td>
                            <td class="py-3 px-4 text-right">--</td>
                            <td class="py-3 px-4">
                                <span class="status-dot status-warning"></span>
                                <span class="text-sm">ç»Ÿè®¡å€¼</span>
                            </td>
                        </tr>
                    `;
                }

                const percent = row.total > 0 ? (row.remaining / row.total) * 100 : 100;
                let status = 'success';
                if (percent < 20) status = 'danger';
                else if (percent < 50) status = 'warning';

                return `
                    <tr style="border-bottom: 1px solid var(--border-color)">
                        <td class="py-3 px-4">${row.name}</td>
                        <td class="py-3 px-4 text-right">${formatNumber(row.used)}</td>
                        <td class="py-3 px-4 text-right">${formatNumber(row.total)}</td>
                        <td class="py-3 px-4 text-right font-medium">${formatNumber(row.remaining)}</td>
                        <td class="py-3 px-4">
                            <span class="status-dot status-${status}"></span>
                            <span class="text-sm">${percent.toFixed(1)}% å‰©ä½™</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== Chart ====================
        function getChartTheme(themeName = document.documentElement.getAttribute('data-theme') || 'light') {
            const dark = themeName === 'dark';
            return {
                textColor: dark ? '#b0aea5' : '#6f6b61',
                gridColor: dark ? 'rgba(74, 69, 63, 0.5)' : 'rgba(176, 174, 165, 0.35)',
                tokenColor: dark ? '#e0b866' : '#d4a24c',
                callColor: dark ? '#8fa26f' : '#788c5d',
                muted: dark ? 'rgba(176, 174, 165, 0.2)' : 'rgba(176, 174, 165, 0.2)'
            };
        }

        function applyChartTheme(themeName) {
            const colors = getChartTheme(themeName);
            const chartsWithAxes = [state.chart, state.mcpChart, state.accountChart];

            chartsWithAxes.forEach(chart => {
                if (!chart?.options?.scales) return;
                Object.values(chart.options.scales).forEach(scale => {
                    if (!scale) return;
                    if (scale.ticks) scale.ticks.color = colors.textColor;
                    if (scale.grid) scale.grid.color = colors.gridColor;
                });
            });

            if (state.quotaChart?.options?.plugins?.legend?.labels) {
                state.quotaChart.options.plugins.legend.labels.color = colors.textColor;
            }

            [state.chart, state.quotaChart, state.mcpChart, state.accountChart].forEach(chart => {
                if (chart) chart.update();
            });
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const colors = getChartTheme();

            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ¯å°æ—¶ Token',
                            data: [],
                            borderColor: colors.tokenColor,
                            backgroundColor: 'rgba(212, 162, 76, 0.18)',
                            fill: true,
                            tension: 0.35,
                            yAxisID: 'yTokens'
                        },
                        {
                            label: 'æ¯å°æ—¶è°ƒç”¨',
                            data: [],
                            borderColor: colors.callColor,
                            backgroundColor: 'rgba(120, 140, 93, 0.14)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'yCalls'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor
                            }
                        },
                        yTokens: {
                            beginAtZero: true,
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor
                            },
                            title: {
                                display: true,
                                text: 'Token',
                                color: colors.textColor
                            }
                        },
                        yCalls: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor
                            },
                            title: {
                                display: true,
                                text: 'Calls',
                                color: colors.textColor
                            }
                        }
                    }
                }
            });
        }

        function initVisualCharts() {
            const colors = getChartTheme();
            const mcpTools = getActiveMcpTools();

            const quotaCtx = document.getElementById('quotaRingChart').getContext('2d');
            state.quotaChart = new Chart(quotaCtx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²ä½¿ç”¨', 'å‰©ä½™'],
                    datasets: [
                        {
                            label: '5å°æ—¶',
                            data: [0, 100],
                            backgroundColor: ['#d4a24c', colors.muted],
                            borderWidth: 0,
                            radius: '98%',
                            cutout: '70%'
                        },
                        {
                            label: 'æ¯å‘¨',
                            data: [0, 100],
                            backgroundColor: ['#d97757', colors.muted],
                            borderWidth: 0,
                            radius: '66%',
                            cutout: '42%'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: colors.textColor }
                        }
                    }
                }
            });

            const mcpCtx = document.getElementById('mcpBarChart').getContext('2d');
            state.mcpChart = new Chart(mcpCtx, {
                type: 'bar',
                data: {
                    labels: mcpTools.map(tool => tool.name),
                    datasets: [{
                        label: 'è°ƒç”¨æ¬¡æ•°',
                        data: mcpTools.map(() => 0),
                        borderRadius: 10,
                        backgroundColor: ['#d4a24c', '#d97757', '#788c5d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
                        y: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
                    }
                }
            });

            const accountCtx = document.getElementById('accountCompareChart').getContext('2d');
            state.accountChart = new Chart(accountCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Î”Tokens',
                        data: [],
                        borderRadius: 10,
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
                        y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
                    }
                }
            });
        }

        function updateChart(data = null) {
            if (!state.chart) return;

            const trend = data?.trend || {};
            const hasTrendData =
                Array.isArray(trend.labels) &&
                Array.isArray(trend.tokens) &&
                trend.labels.length > 0 &&
                trend.labels.length === trend.tokens.length;

            if (hasTrendData) {
                state.chart.data.labels = trend.labels.map(label => {
                    const parts = String(label).split(' ');
                    return parts.length > 1 ? parts[1] : label;
                });
                state.chart.data.datasets[0].data = trend.tokens;
                state.chart.data.datasets[1].data = Array.isArray(trend.calls)
                    ? trend.calls.map(v => Number(v || 0))
                    : trend.tokens.map(() => 0);
                state.chart.update();
                return;
            }

            if (document.getElementById('saveHistory').checked) {
                const history = JSON.parse(
                    localStorage.getItem(getHistoryStorageKey()) ||
                    (state.platformId === 'glm' ? localStorage.getItem('glm_history') : null) ||
                    '[]'
                );
                const now = Date.now();
                const dayAgo = now - 24 * 60 * 60 * 1000;
                const recentHistory = history
                    .filter(h => h.timestamp > dayAgo)
                    .sort((a, b) => a.timestamp - b.timestamp);

                if (recentHistory.length > 0) {
                    state.chart.data.labels = recentHistory.map(h =>
                        new Date(h.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                    );
                    state.chart.data.datasets[0].data = recentHistory.map(h => h.tokens24h || h.cycleUsed || 0);
                    state.chart.data.datasets[1].data = recentHistory.map(h => h.calls24h || 0);
                    state.chart.update();
                    return;
                }
            }

            state.chart.data.labels = ['æ— æ•°æ®'];
            state.chart.data.datasets[0].data = [0];
            state.chart.data.datasets[1].data = [0];
            state.chart.update();
        }

        function updateVisualCharts(data) {
            if (!data) return;

            const cyclePercent = data.plan?.unavailable ? 0 : Number(data.plan?.cyclePercent || 0);
            const weeklyPercent = data.weekly?.unavailable ? 0 : Number(data.weekly?.percent || 0);

            document.getElementById('quotaCycleChip').textContent = data.plan?.unavailable ? 'Cycle N/A' : `Cycle ${cyclePercent}%`;
            document.getElementById('quotaWeeklyChip').textContent = data.weekly?.unavailable ? 'Week N/A' : `Week ${weeklyPercent}%`;

            if (state.quotaChart) {
                state.quotaChart.data.datasets[0].data = [cyclePercent, Math.max(100 - cyclePercent, 0)];
                state.quotaChart.data.datasets[1].data = [weeklyPercent, Math.max(100 - weeklyPercent, 0)];
                state.quotaChart.update();
            }

            if (state.mcpChart) {
                const tools = getActiveMcpTools();
                state.mcpChart.data.labels = tools.map(tool => tool.name);
                state.mcpChart.data.datasets[0].data = tools.map(tool =>
                    Number(data.mcpUsage?.[tool.id]?.used || 0)
                );
                state.mcpChart.update();
            }

            updateHeatmap(data.trend);
            updateAccountCompareChart();
        }

        function updateHeatmap(trend) {
            const container = document.getElementById('hourlyHeatmap');
            const peakLabel = document.getElementById('heatmapPeak');
            const avgLabel = document.getElementById('heatmapAvg');

            if (!container) return;
            const labels = Array.isArray(trend?.labels) ? trend.labels : [];
            const tokens = Array.isArray(trend?.tokens) ? trend.tokens.map(v => Number(v || 0)) : [];
            const calls = Array.isArray(trend?.calls) ? trend.calls.map(v => Number(v || 0)) : [];

            if (labels.length === 0 || tokens.length === 0) {
                container.innerHTML = '<div class="text-xs col-span-8" style="color: var(--text-secondary)">æš‚æ— è¶‹åŠ¿æ•°æ®</div>';
                peakLabel.textContent = '--';
                avgLabel.textContent = '--';
                return;
            }

            const maxToken = Math.max(...tokens, 1);
            const avgToken = Math.round(tokens.reduce((sum, val) => sum + val, 0) / tokens.length);
            const peakToken = Math.max(...tokens);

            container.innerHTML = tokens.map((value, index) => {
                const ratio = maxToken > 0 ? value / maxToken : 0;
                const alpha = (0.12 + ratio * 0.84).toFixed(3);
                const label = labels[index] || `slot-${index}`;
                const call = Number(calls[index] || 0);
                const title = `${label} | Tokens: ${formatNumber(value)} | Calls: ${formatNumber(call)}`;
                return `<div class="heat-cell" style="background-color: rgba(212, 162, 76, ${alpha})" title="${title}"></div>`;
            }).join('');

            peakLabel.textContent = formatNumber(peakToken);
            avgLabel.textContent = formatNumber(avgToken);
        }

        function updateAccountCompareChart() {
            const hint = document.getElementById('accountCompareHint');
            if (!state.accountChart || !hint) return;

            if (state.apiKeys.length === 0) {
                state.accountChart.data.labels = ['--'];
                state.accountChart.data.datasets[0].data = [0];
                state.accountChart.data.datasets[0].backgroundColor = ['rgba(176,174,165,0.45)'];
                state.accountChart.update();
                hint.textContent = 'æš‚æ— è´¦æˆ·æ•°æ®ã€‚';
                return;
            }

            const labels = state.apiKeys.map((_, index) => `è´¦æˆ· ${index + 1}`);
            const values = state.apiKeys.map(key => Number(state.keyTracking[key]?.delta?.tokens || 0));
            const maxValue = values.length ? Math.max(...values) : 0;
            const maxIndex = values.indexOf(maxValue);

            state.accountChart.data.labels = labels;
            state.accountChart.data.datasets[0].data = values;
            state.accountChart.data.datasets[0].backgroundColor = labels.map((_, index) => {
                if (index === state.currentKeyIndex) return 'rgba(212, 162, 76, 0.95)';
                if (index === maxIndex && maxValue > 0) return 'rgba(120, 140, 93, 0.86)';
                return 'rgba(176, 174, 165, 0.46)';
            });
            state.accountChart.update();

            if (maxValue > 0) {
                hint.textContent = `å½“å‰æœ€å¤§å¢é‡: è´¦æˆ· ${maxIndex + 1} Â· Î”Tokens ${formatNumber(maxValue)}`;
            } else {
                hint.textContent = 'å½“å‰æ‰€æœ‰è´¦æˆ· Î”Tokens ä¸º 0ï¼Œå…ˆä½¿ç”¨ä¸€æ®µæ—¶é—´å†çœ‹å·®å¼‚ã€‚';
            }
        }

        function saveHistoryData(data) {
            if (!document.getElementById('saveHistory').checked) return;

            const history = JSON.parse(localStorage.getItem(getHistoryStorageKey()) || '[]');
            history.push({
                timestamp: Date.now(),
                cycleUsed: data.plan?.cycleUsed || 0,
                weeklyPercent: data.weekly?.percent || 0,
                tokens24h: data.modelSummary?.totalTokens24h || 0,
                calls24h: data.modelSummary?.totalCalls24h || 0
            });

            // Keep only last 100 entries
            localStorage.setItem(getHistoryStorageKey(), JSON.stringify(history.slice(-100)));
        }

        // ==================== Theme ====================
        function initTheme() {
            const savedTheme = localStorage.getItem('glm_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            applyChartTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('glm_theme', newTheme);
            updateThemeIcon(newTheme);
            applyChartTheme(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            }
        }

        // ==================== Settings Panel ====================
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function updateRefreshInterval(shouldPersist = true) {
            if (state.refreshTimer) {
                clearInterval(state.refreshTimer);
                state.refreshTimer = null;
            }

            const interval = parseInt(document.getElementById('refreshInterval').value);
            if (interval > 0) {
                state.refreshTimer = setInterval(refreshData, interval);
            }

            if (shouldPersist) {
                saveSettings();
            }
        }

        // ==================== Utilities ====================
        function showLoading(show) {
            document.getElementById('loadingState').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            alert.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        function updateLastRefresh() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                `æœ€åæ›´æ–°: ${now.toLocaleTimeString('zh-CN')}`;
        }

        function formatDate(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '--';
            }
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatTime(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '--';
            }
            const now = new Date();
            const diff = date - now;

            if (diff < 0) return 'å·²è¿‡æœŸ';

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿå`;
            }
            return `${minutes}åˆ†é’Ÿå`;
        }

        function formatNumber(num) {
            const safeNum = Number(num || 0);
            if (safeNum >= 10000000) {
                return (safeNum / 10000000).toFixed(1) + 'åƒä¸‡';
            }
            if (safeNum >= 10000) {
                return (safeNum / 10000).toFixed(1) + 'ä¸‡';
            }
            return safeNum.toLocaleString();
        }
    </script>
</body>
</html>
